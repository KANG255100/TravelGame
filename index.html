<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„æ—…éŠé›²ç«¯æ‰‹å¸³ v1.4.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary-color: #2a9d8f; --danger-color: #e63946; --star-color: #ffbe0b;
            --bg-color: #f4f7f6; --white: #ffffff; --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        html, body { overflow-x: hidden; width: 100%; margin: 0; padding: 0; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); padding-bottom: 50px; }
        
        /* Banner & Grid */
        .top-banner { width: 100%; height: 320px; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; color: white; position: relative; }
        .top-banner h1 { font-family: 'Caveat', cursive; font-size: 5rem; margin: 0; transform: rotate(-4deg); text-shadow: 3px 6px 15px rgba(0,0,0,0.4); text-align: center; }
        .main-content { max-width: 1100px; margin: 30px auto 0; padding: 0 15px; }
        .grid-system { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        
        /* Card Styles */
        .trip-card { background: var(--white); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); display: flex; flex-direction: column; min-height: 480px; position: relative; }
        .img-container { position: relative; width: 100%; height: 180px; background: #333; }
        .trip-img { width: 100%; height: 100%; object-fit: cover; }
        .card-tools { padding: 10px; background: #fafafa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; gap: 8px; }
        .btn-action { flex: 1; border: none; height: 38px; border-radius: 6px; font-weight: 900; cursor: pointer; background: #eee; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; color: #333; }

        /* Side Panel & 4-Buttons */
        .side-panel { position: fixed; top: 0; right: -100%; width: 80%; height: 100%; background: white; box-shadow: -10px 0 30px rgba(0,0,0,0.25); z-index: 3000; transition: right 0.4s ease; display: flex; flex-direction: column; }
        .side-panel.open { right: 0; }
        @media (max-width: 600px) { .side-panel { width: 100%; } }

        .panel-header { padding: 15px; background: var(--primary-color); color: white; display: flex; justify-content: space-between; align-items: center; }
        .header-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; width: 160px; }
        .panel-ctrl-btn { padding: 6px 4px; border-radius: 6px; background: rgba(255,255,255,0.2); border: 1px solid white; color: white; font-size: 0.75rem; cursor: pointer; font-weight: bold; text-align: center; }
        .panel-ctrl-btn.active { background: white; color: var(--primary-color); }

        /* Itinerary & Finance */
        .itinerary-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .finance-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .cat-tag { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; color: white; margin-right: 5px; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 4000; backdrop-filter: blur(4px); }
        .modal-content input, .modal-content select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

    <header class="top-banner" id="mainBanner"><h1>Explore</h1></header>

    <main class="main-content">
        <div style="text-align:right; margin-bottom:20px;">
            <button onclick="addNewTrip()" class="btn-action" style="background:var(--primary-color); color:white; width:auto; padding:0 25px; border-radius:20px;">+ æ–°å¢æ—…ç¨‹</button>
        </div>
        <div id="tripGrid" class="grid-system"></div>
    </main>

    <div id="sidePanel" class="side-panel">
        <div class="panel-header">
            <div style="flex:1; display:flex; align-items:center; gap:10px;">
                <span onclick="closeSidePanel()" style="cursor:pointer; font-size:24px;">âœ•</span>
                <h3 id="panelTitle" style="margin:0; font-size:1rem; word-break:break-all;">è¡Œç¨‹</h3>
            </div>
            <div class="header-buttons">
                <button id="btnEdit" class="panel-ctrl-btn" onclick="setPanelMode('edit')">ğŸ”“ ç·¨è¼¯</button>
                <button id="btnAccount" class="panel-ctrl-btn" onclick="openFinanceModal()">ğŸ’° è¨˜å¸³</button>
                <button id="btnDelete" class="panel-ctrl-btn" onclick="setPanelMode('delete')">ğŸ—‘ï¸ åˆªé™¤</button>
                <button id="btnReport" class="panel-ctrl-btn" onclick="setPanelMode('report')">ğŸ“Š æ˜ç´°</button>
            </div>
        </div>

        <div id="dayTabsWrap" style="background:#f0f0f0; display:flex; height:45px; border-bottom:1px solid #ddd;">
            <div style="width:80px; display:flex; align-items:center; justify-content:center; font-weight:bold; cursor:pointer; background:#e0e0e0;" onclick="addNewDay()">+å¤©æ•¸</div>
            <div id="dayTabs" style="display:flex; overflow-x:auto; flex:1; align-items:center; padding:0 10px; gap:8px;"></div>
        </div>

        <div id="itineraryContent" class="itinerary-content"></div>
    </div>

    <div class="modal-overlay" id="financeModal">
        <div class="modal-content" style="background:white; padding:20px; border-radius:15px; width:85%; max-width:320px;">
            <h3 style="margin:0 0 15px 0; text-align:center;">ğŸ’° æ–°å¢æ”¯å‡º</h3>
            <input type="number" id="expAmount" placeholder="è¼¸å…¥é‡‘é¡" inputmode="decimal">
            <select id="expCurrency">
                <option value="TWD">TWD (å°å¹£)</option>
                <option value="JPY">JPY (æ—¥å¹£)</option>
                <option value="KRW">KRW (éŸ“å…ƒ)</option>
                <option value="USD">USD (ç¾é‡‘)</option>
            </select>
            <select id="expCategory">
                <option value="ä½å®¿">ğŸ¨ ä½å®¿</option>
                <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                <option value="åƒå–">ğŸ´ åƒå–</option>
                <option value="å¨›æ¨‚">ğŸ¡ å¨›æ¨‚</option>
                <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                <option value="å…¶ä»–">â“ å…¶ä»–</option>
            </select>
            <input type="text" id="expNote" placeholder="å‚™è¨»å…§å®¹">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-action" style="background:var(--primary-color); color:white;" onclick="saveExpense()">å„²å­˜</button>
                <button class="btn-action" onclick="closeModal('financeModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="confirmModal"><div class="modal-content" style="background:white; padding:20px; border-radius:15px; width:280px; text-align:center;">
        <h3 id="confirmMsg">ç¢ºå®šï¼Ÿ</h3><div style="display:flex; gap:10px; margin-top:20px;"><button class="btn-action" style="background:var(--danger-color); color:white;" id="modalYes">ç¢ºå®š</button><button class="btn-action" onclick="closeModal('confirmModal')">å–æ¶ˆ</button></div>
    </div></div>

    <script>
        // Firebase é…ç½® (æ²¿ç”¨ä½ çš„é…ç½®)
        const firebaseConfig = { apiKey: "AIzaSyA4g7tQuKmPHRYZNdbxWbHFtvc5RnJQVzM", authDomain: "travelgame-91b3a.firebaseapp.com", databaseURL: "https://travelgame-91b3a-default-rtdb.firebaseio.com", projectId: "travelgame-91b3a", storageBucket: "travelgame-91b3a.firebasestorage.app", messagingSenderId: "498309085943", appId: "1:498309085943:web:764dae004f4c9f96d7b1f2" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentTripId = null, currentDayIndex = 0, panelMode = 'view'; // view, edit, delete, report
        let sortableInstance = null;
        const exchangeRates = { JPY: 0.22, TWD: 1, KRW: 0.024, USD: 32.5 };

        window.onload = () => loadCloudData();

        function loadCloudData() {
            db.ref('trips').orderByChild('order').on('value', snap => {
                const grid = document.getElementById('tripGrid'); grid.innerHTML = '';
                snap.forEach(c => renderCard(c.key, c.val()));
            });
        }

        function renderCard(id, item) {
            const html = `
                <article class="trip-card" data-id="${id}">
                    <div class="img-container"><img src="${item.img}" class="trip-img"></div>
                    <div class="card-tools">
                        <button class="btn-action" onclick="openSidePanel('${id}', '${item.title}')">æŸ¥çœ‹è¡Œç¨‹</button>
                        <button class="btn-action" style="color:var(--danger-color);" onclick="askDeleteTrip('${id}')">åˆªé™¤</button>
                    </div>
                    <div style="padding:15px;">
                        <div style="font-weight:bold; font-size:1.2rem;">${item.title}</div>
                        <div style="color:#666; font-size:0.9rem;">${item.date}</div>
                    </div>
                </article>`;
            document.getElementById('tripGrid').insertAdjacentHTML('beforeend', html);
        }

        function openSidePanel(id, title) {
            currentTripId = id; currentDayIndex = 0; panelMode = 'view';
            document.getElementById('panelTitle').innerText = title;
            document.getElementById('sidePanel').classList.add('open');
            updateUI(); loadData();
        }

        function setPanelMode(m) {
            panelMode = (panelMode === m) ? 'view' : m;
            updateUI(); loadData();
        }

        function updateUI() {
            ['Edit', 'Delete', 'Report'].forEach(b => {
                document.getElementById('btn'+b).classList.toggle('active', panelMode === b.toLowerCase());
            });
            document.getElementById('dayTabsWrap').style.display = (panelMode === 'report') ? 'none' : 'flex';
        }

        function loadData() {
            if (panelMode === 'report') return loadReport();
            
            const path = `trips/${currentTripId}/days`;
            db.ref(path).off();
            db.ref(path).on('value', snap => {
                const tabs = document.getElementById('dayTabs'), content = document.getElementById('itineraryContent');
                tabs.innerHTML = ''; content.innerHTML = '';
                const days = snap.val() || [];
                days.forEach((day, idx) => {
                    const btn = document.createElement('div');
                    btn.className = 'tab-btn';
                    btn.style = `padding:5px 15px; border-radius:15px; background:${idx===currentDayIndex?'var(--primary-color)':'#fff'}; color:${idx===currentDayIndex?'#fff':'#333'}; cursor:pointer; font-size:0.8rem; border:1px solid #ddd; white-space:nowrap;`;
                    btn.innerText = `Day ${idx+1}`;
                    btn.onclick = () => { currentDayIndex = idx; loadData(); };
                    tabs.appendChild(btn);
                    
                    if(idx === currentDayIndex) {
                        (day.items || []).forEach((item, iIdx) => {
                            content.innerHTML += `
                                <div class="itinerary-item" style="border-left:3px solid var(--primary-color); margin-bottom:20px; padding-left:10px; position:relative;">
                                    <div style="font-size:0.8rem; color:#888;">${item.time}</div>
                                    <div style="font-weight:bold;">${item.place}</div>
                                    <div style="font-size:0.9rem; color:#666;">${item.note}</div>
                                    ${panelMode === 'delete' ? `<div onclick="deleteItem(${iIdx})" style="position:absolute; right:0; top:0; color:red;">âœ•</div>` : ''}
                                </div>`;
                        });
                    }
                });
            });
        }

        function openFinanceModal() { document.getElementById('financeModal').style.display = 'flex'; }
        
        function saveExpense() {
            const amount = document.getElementById('expAmount').value;
            const currency = document.getElementById('expCurrency').value;
            const category = document.getElementById('expCategory').value;
            const note = document.getElementById('expNote').value;
            if(!amount) return alert('è«‹è¼¸å…¥é‡‘é¡');

            db.ref(`trips/${currentTripId}/finance`).push({
                amount: parseFloat(amount),
                currency, category, note,
                time: new Date().toLocaleString()
            });
            closeModal('financeModal');
            if(panelMode === 'report') loadReport();
        }

        function loadReport() {
            db.ref(`trips/${currentTripId}/finance`).once('value', snap => {
                const content = document.getElementById('itineraryContent');
                content.innerHTML = '<h4>ğŸ“Š æ—…ç¨‹æ¶ˆè²»æ˜ç´°</h4>';
                let totalTWD = 0;
                const catTotal = {};

                snap.forEach(child => {
                    const exp = child.val();
                    const twd = exp.amount * (exchangeRates[exp.currency] || 1);
                    totalTWD += twd;
                    catTotal[exp.category] = (catTotal[exp.category] || 0) + twd;

                    content.innerHTML += `
                        <div class="finance-item">
                            <div>
                                <span class="cat-tag" style="background:var(--primary-color)">${exp.category}</span>
                                <span>${exp.note || 'ç„¡å‚™è¨»'}</span>
                            </div>
                            <div style="text-align:right">
                                <div style="font-weight:bold">${exp.amount} ${exp.currency}</div>
                                <div style="font-size:0.7rem; color:#888;">ç´„ NT$ ${Math.round(twd)}</div>
                            </div>
                        </div>`;
                });
                content.innerHTML = `<div style="background:#eee; padding:15px; border-radius:10px; margin-bottom:15px;">
                    <div style="font-size:0.8rem;">é ç®—ç¸½æ”¯å‡º</div>
                    <div style="font-size:1.8rem; font-weight:bold; color:var(--primary-color)">NT$ ${Math.round(totalTWD).toLocaleString()}</div>
                </div>` + content.innerHTML;
            });
        }

        function closeSidePanel() { document.getElementById('sidePanel').classList.remove('open'); }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function askDeleteTrip(id) { 
            if(confirm("ç¢ºå®šåˆªé™¤é€™è¶Ÿè¡Œç¨‹å—ï¼Ÿ")) db.ref('trips/'+id).remove();
        }
    </script>
</body>
</html>
